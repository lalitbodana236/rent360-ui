<ng-container *ngIf="data as vm">
  <div class="r360-page">
    <r360-page-header [title]="'Good Morning, ' + userName" subtitle="Role-based overview"></r360-page-header>

    <section class="r360-section r360-panel">
      <div class="flex flex-col gap-3 xl:flex-row xl:items-center xl:justify-between">
        <div class="flex flex-wrap items-center gap-2" *ngIf="availablePersonas.length > 1">
          <button
            *ngFor="let persona of availablePersonas"
            type="button"
            class="r360-chip"
            [ngClass]="selectedPersona === persona ? 'r360-chip-active' : ''"
            (click)="selectPersona(persona)"
          >
            {{ personaLabel(persona) }}
          </button>
        </div>

        <div class="grid grid-cols-1 gap-2 sm:grid-cols-3 xl:min-w-[430px]">
          <label class="text-xs font-medium text-gray-500 dark:text-gray-300">
            View
            <select class="r360-input mt-1 !py-1.5" [value]="viewMode" (change)="changeViewMode($any($event.target).value)">
              <option value="monthly">Monthly</option>
              <option value="yearly">Yearly</option>
            </select>
          </label>

          <label class="text-xs font-medium text-gray-500 dark:text-gray-300">
            Month
            <select class="r360-input mt-1 !py-1.5" [value]="selectedMonth" (change)="changeMonth($any($event.target).value)" [disabled]="viewMode === 'yearly'">
              <option *ngFor="let month of monthOptions" [value]="month.value">{{ month.label }}</option>
            </select>
          </label>

          <label class="text-xs font-medium text-gray-500 dark:text-gray-300">
            Year
            <select class="r360-input mt-1 !py-1.5" [value]="selectedYear" (change)="changeYear($any($event.target).value)">
              <option *ngFor="let year of yearOptions" [value]="year">{{ year }}</option>
            </select>
          </label>
        </div>
      </div>
    </section>

    <section class="r360-section">
      <h2 class="mb-4 break-words text-xl font-semibold sm:text-2xl">{{ viewLabel }}</h2>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 2xl:grid-cols-4">
        <r360-card *ngFor="let kpi of vm.kpis" class="block transition-shadow hover:shadow-md">
          <div class="mb-2 text-xs uppercase tracking-wide text-gray-500">{{ kpi.label }}</div>
          <div class="r360-kpi-value">{{ kpi.value }}</div>
        </r360-card>
      </div>
    </section>

    <section class="r360-section" *ngIf="selectedPersona === 'societyAdmin' && vm.adminView">
      <h3 class="mb-4 text-xl font-semibold">Society Admin Combined View</h3>
      <div class="grid grid-cols-1 gap-4 xl:grid-cols-3">
        <r360-card>
          <div class="mb-3 text-sm font-semibold">Owner Insights</div>
          <div class="space-y-2">
            <div class="flex items-center justify-between text-sm" *ngFor="let item of vm.adminView.ownerInsights">
              <span class="text-gray-500 dark:text-gray-300">{{ item.label }}</span>
              <span class="font-semibold">{{ item.value }}</span>
            </div>
          </div>
        </r360-card>

        <r360-card>
          <div class="mb-3 text-sm font-semibold">Tenant Insights</div>
          <div class="space-y-2">
            <div class="flex items-center justify-between text-sm" *ngFor="let item of vm.adminView.tenantInsights">
              <span class="text-gray-500 dark:text-gray-300">{{ item.label }}</span>
              <span class="font-semibold">{{ item.value }}</span>
            </div>
          </div>
        </r360-card>

        <r360-card>
          <div class="mb-3 text-sm font-semibold">Maintenance & Meetings</div>
          <div class="space-y-2">
            <div class="flex items-center justify-between text-sm" *ngFor="let item of vm.adminView.operationsInsights">
              <span class="text-gray-500 dark:text-gray-300">{{ item.label }}</span>
              <span class="font-semibold">{{ item.value }}</span>
            </div>
          </div>
        </r360-card>
      </div>

      <div class="mt-4 grid grid-cols-1 gap-4">
        <r360-card>
          <div class="mb-4 flex items-center justify-between">
            <h4 class="text-lg font-semibold">Owner / Tenant / Member Directory</h4>
            <span class="text-xs text-gray-500">Status + quick action</span>
          </div>
          <r360-table>
            <thead>
              <tr class="border-b border-gray-200 dark:border-gray-700">
                <th class="r360-th">Name</th>
                <th class="r360-th">Role</th>
                <th class="r360-th">Property</th>
                <th class="r360-th">Unit</th>
                <th class="r360-th">Status</th>
                <th class="r360-th">Action</th>
              </tr>
            </thead>
            <tbody>
              <tr class="r360-row" *ngFor="let row of vm.adminView.directory">
                <td class="r360-td">{{ row.name }}</td>
                <td class="r360-td">{{ row.role }}</td>
                <td class="r360-td">{{ row.property }}</td>
                <td class="r360-td">{{ row.unit }}</td>
                <td class="r360-td"><r360-status-badge [value]="row.status"></r360-status-badge></td>
                <td class="r360-td"><button class="r360-btn-secondary">Send msg</button></td>
              </tr>
            </tbody>
          </r360-table>
        </r360-card>

        <r360-card>
          <div class="mb-4 flex items-center justify-between">
            <h4 class="text-lg font-semibold">Rent + Maintenance Defaulters</h4>
            <span class="text-xs text-gray-500">Not paid amount and late days</span>
          </div>
          <r360-table>
            <thead>
              <tr class="border-b border-gray-200 dark:border-gray-700">
                <th class="r360-th">Name</th>
                <th class="r360-th">Property</th>
                <th class="r360-th">Unit</th>
                <th class="r360-th">Rent Due</th>
                <th class="r360-th">Maintenance Due</th>
                <th class="r360-th">Days Late</th>
              </tr>
            </thead>
            <tbody>
              <tr class="r360-row" *ngFor="let row of vm.adminView.defaulters">
                <td class="r360-td">{{ row.name }}</td>
                <td class="r360-td">{{ row.property }}</td>
                <td class="r360-td">{{ row.unit }}</td>
                <td class="r360-td font-semibold text-danger">{{ row.rentDue }}</td>
                <td class="r360-td font-semibold text-warning">{{ row.maintenanceDue }}</td>
                <td class="r360-td">{{ row.daysLate }}</td>
              </tr>
            </tbody>
          </r360-table>
        </r360-card>

        <r360-card>
          <div class="mb-4 flex items-center justify-between">
            <h4 class="text-lg font-semibold">Historical Owner / Tenant Records</h4>
            <span class="text-xs text-gray-500">Retained in system, not removed</span>
          </div>
          <r360-table>
            <thead>
              <tr class="border-b border-gray-200 dark:border-gray-700">
                <th class="r360-th">Name</th>
                <th class="r360-th">Role</th>
                <th class="r360-th">Property</th>
                <th class="r360-th">Unit</th>
                <th class="r360-th">From</th>
                <th class="r360-th">To</th>
                <th class="r360-th">Reason</th>
              </tr>
            </thead>
            <tbody>
              <tr class="r360-row" *ngFor="let row of vm.adminView.history">
                <td class="r360-td">{{ row.name }}</td>
                <td class="r360-td">{{ row.role }}</td>
                <td class="r360-td">{{ row.property }}</td>
                <td class="r360-td">{{ row.unit }}</td>
                <td class="r360-td">{{ row.from }}</td>
                <td class="r360-td">{{ row.to }}</td>
                <td class="r360-td">{{ row.moveOutReason }}</td>
              </tr>
            </tbody>
          </r360-table>
        </r360-card>
      </div>
    </section>

    <section class="r360-section" *ngIf="insights.length">
      <h3 class="mb-4 text-xl font-semibold">Cross-Module Intelligence</h3>
      <div class="grid grid-cols-1 gap-4 lg:grid-cols-3">
        <r360-card *ngFor="let insight of insights" class="block">
          <div class="text-xs uppercase tracking-wide text-gray-500">{{ insight.title }}</div>
          <div class="mt-2 text-2xl font-bold text-gray-900 dark:text-gray-100">{{ insight.value }}</div>
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-300">{{ insight.description }}</p>
        </r360-card>
      </div>
    </section>

    <section class="grid grid-cols-1 gap-4 xl:grid-cols-5">
      <r360-card class="block xl:col-span-2">
        <h3 class="mb-6 text-xl font-semibold">Payments Overview</h3>
        <div *ngFor="let row of vm.collectionHealth" class="mb-5 last:mb-0">
          <div class="mb-2 flex items-center justify-between text-sm">
            <span>{{ row.label }}</span>
            <span>{{ row.percent }}%</span>
          </div>
          <div class="h-2 overflow-hidden rounded-lg bg-gray-200 dark:bg-gray-700">
            <div
              class="h-full rounded-lg"
              [ngClass]="[
                widthClass(row.percent),
                row.tone === 'success' ? 'bg-success' : '',
                row.tone === 'info' ? 'bg-secondary' : '',
                row.tone === 'warning' ? 'bg-warning' : '',
                row.tone === 'danger' ? 'bg-danger' : ''
              ]"
            ></div>
          </div>
        </div>
      </r360-card>

      <r360-card class="block xl:col-span-3">
        <div class="mb-6 flex items-center justify-between">
          <h3 class="text-xl font-semibold">{{ chargesTitle }}</h3>
          <r360-pagination></r360-pagination>
        </div>
        <r360-table>
          <thead>
            <tr class="border-b border-gray-200 dark:border-gray-700">
              <th class="r360-th">Amount</th>
              <th class="r360-th">Property</th>
              <th class="r360-th">Unit</th>
              <th class="r360-th">Description</th>
              <th class="r360-th">Status</th>
              <th class="r360-th">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of vm.charges" class="r360-row">
              <td class="r360-td">{{ c.amount }}</td>
              <td class="r360-td">{{ c.property }}</td>
              <td class="r360-td">{{ c.unit }}</td>
              <td class="r360-td">{{ c.description }}</td>
              <td class="r360-td"><r360-status-badge [value]="c.status"></r360-status-badge></td>
              <td class="r360-td"><a class="r360-action-link" href="#">{{ c.action }}</a></td>
            </tr>
          </tbody>
        </r360-table>
      </r360-card>
    </section>
  </div>
</ng-container>





